#!/usr/bin/env ruby
# Copyright (c) 2021 Alexandre ZANNI (noraj)

require 'yaml'
require 'json'
require 'kramdown'

pwndoc_file = ARGV[0]
reconmap_file = ARGV[1]

pwndoc_data = YAML.load_file(pwndoc_file)
reconmap_data = {
  'vulnerabilities' => []
}

def to_md(html)
  html ||= ''
  Kramdown::Document.new(html, html_to_native: true).to_kramdown
end

pwndoc_data.each do |pv|
  pv['details'].each do |details|
    rv = {
      'summary' => "[#{details['locale']}] #{details['title']}",
      'description' => to_md(details['description']),
      'proof_of_concept' => to_md(details['observation']),
      'impact' => nil,
      'solution' => "#{to_md(details['remediation'])}\n\nReferences:\n\n#{details['references'].join("\n- ")}",
      'risk' => pv['cvssSeverity'],
      'cvss_score' => pv['cvssScore'],
      'cvss_vector' => pv['cvssv3'],
      'status' => 'open',
      'substatus' => 'reported',
      'tags' => nil,
      'category_id' => nil,
      'category_name' => nil,
      'project_id' => nil,
      'project_name' => nil,
      'target_id' => nil,
      'target_name' => nil,
      'target_kind' => nil,
      'is_template' => 1,
      'creator_uid' => 1,
      'creator_full_name' => 'Jane Doe'
    }
    reconmap_data['vulnerabilities'].push(rv)
  end
end

File.open(reconmap_file, 'w') do |file|
  JSON.dump(reconmap_data, file)
end

